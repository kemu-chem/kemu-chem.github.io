<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cell Counter</title>
    <link rel="stylesheet" href="main_style.css">
    <link rel="stylesheet" href="src/cell_counter.css">
</head>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-QQYR2QR1LP"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-QQYR2QR1LP');
</script>

<body>
    <div class="card">
        <a href="index.html" class="portal-btn">&#8592; Portal</a>
        <h1>Cell Counter</h1>
        <p class="subtitle">Automatic cell counting from microscopy images using OpenCV.js</p>

        <!-- Image input -->
        <div class="input-section">
            <button id="load-btn" disabled>Load Image</button>
            <input type="file" id="file-input" accept="image/*,.tif,.tiff" hidden>
            <span id="cv-status">Loading OpenCV.js...</span>
        </div>

        <!-- Drop zone -->
        <div id="drop_zone">Drop image here, or click "Load Image"</div>

        <!-- No image placeholder -->
        <div class="no-image-msg" id="no-image-msg" hidden>
            No image loaded yet. Drop an image or click the button above.
        </div>

        <!-- Canvases -->
        <div id="canvas-area" hidden>

            <!-- Overlay toolbar -->
            <div class="overlay-toolbar">
                <button id="overlay-btn">⊕ Overlay Rows</button>
                <div class="opacity-ctrl" id="opacity-ctrl">
                    <span class="opacity-label">Result opacity:</span>
                    <input type="range" id="opacity-slider" min="0" max="100" value="60">
                    <span id="opacity-val">60%</span>
                </div>
            </div>

            <div class="canvas-rows-wrap" id="canvas-rows-wrap">
                <!-- Overlay container: Row1 is the base, Row2 can be positioned absolutely on top -->
                <div class="overlay-container" id="overlay-container">

                    <!-- Row 1: Original + R / G / B channel images -->
                    <div class="canvas-row" id="canvas-row1">
                        <div class="canvas-panel">
                            <div class="canvas-panel-label">Original</div>
                            <canvas id="canvas-orig"></canvas>
                        </div>
                        <div class="canvas-panel">
                            <div class="canvas-panel-label ch-r">R channel</div>
                            <canvas id="canvas-ch-r"></canvas>
                        </div>
                        <div class="canvas-panel">
                            <div class="canvas-panel-label ch-g">G channel</div>
                            <canvas id="canvas-ch-g"></canvas>
                        </div>
                        <div class="canvas-panel">
                            <div class="canvas-panel-label ch-b">B channel</div>
                            <canvas id="canvas-ch-b"></canvas>
                        </div>
                    </div>

                    <!-- Row 2: Result + R / G / B masks -->
                    <div class="canvas-row" id="canvas-row2">
                        <div class="canvas-panel">
                            <div class="canvas-panel-label">Result</div>
                            <canvas id="canvas-result"></canvas>
                        </div>
                        <div class="canvas-panel">
                            <div class="canvas-panel-label ch-r mask">R mask</div>
                            <canvas id="canvas-mask-r"></canvas>
                        </div>
                        <div class="canvas-panel">
                            <div class="canvas-panel-label ch-g mask">G mask</div>
                            <canvas id="canvas-mask-g"></canvas>
                        </div>
                        <div class="canvas-panel">
                            <div class="canvas-panel-label ch-b mask">B mask</div>
                            <canvas id="canvas-mask-b"></canvas>
                        </div>
                    </div>

                </div><!-- /overlay-container -->
            </div><!-- /canvas-rows-wrap -->
        </div><!-- /canvas-area -->

        <!-- Controls -->
        <div class="controls">
            <h3>Detection Parameters</h3>

            <!-- Result view toggle -->
            <div class="view-toggle" style="margin-bottom: 12px;">
                <button class="view-btn active" data-view="overlay">Detected Cells</button>
                <button class="view-btn" data-view="thresh">Threshold Mask</button>
            </div>

            <hr class="section-divider">

            <div class="slider-row">
                <label for="thresh">Threshold</label>
                <input type="range" id="thresh" min="0" max="255" value="128">
                <span class="slider-val" id="thresh-val">128</span>
            </div>

            <div class="check-row">
                <label><input type="checkbox" id="otsu"> Otsu auto-threshold</label>
                <label><input type="checkbox" id="invert" checked> Invert</label>
                <label><input type="checkbox" id="negative"> Negative Image</label>
            </div>

            <hr class="section-divider">

            <!-- Channel Parameters -->
            <h3 style="margin: 0 0 10px; font-size: 1em; color: #333;">Channel Parameters</h3>
            <div class="ch-params-section">
                <div class="ch-tabs">
                    <button class="ch-tab active" data-ch="orig" style="color:#555;">Global</button>
                    <button class="ch-tab" data-ch="r">R</button>
                    <button class="ch-tab" data-ch="g">G</button>
                    <button class="ch-tab" data-ch="b">B</button>
                </div>

                <!-- Global (Original) panel -->
                <div class="ch-panel active" data-ch="orig" id="ch-panel-orig">
                    <div class="slider-row">
                        <label for="orig-blur">Blur radius</label>
                        <input type="range" id="orig-blur" min="1" max="21" step="2" value="1">
                        <span class="slider-val" id="orig-blur-val">1</span>
                    </div>
                    <div class="slider-row">
                        <label for="orig-morph-open">Open iterations</label>
                        <input type="range" id="orig-morph-open" min="0" max="10" value="0">
                        <span class="slider-val" id="orig-morph-open-val">0</span>
                    </div>
                    <div class="slider-row">
                        <label for="orig-morph-close">Close iterations</label>
                        <input type="range" id="orig-morph-close" min="0" max="10" value="0">
                        <span class="slider-val" id="orig-morph-close-val">0</span>
                    </div>
                    <hr class="section-divider">
                    <div class="area-row">
                        <label for="orig-min-area">Min area (px²)</label>
                        <input type="number" id="orig-min-area" min="1" value="1">
                    </div>
                    <div class="area-row">
                        <label for="orig-max-area">Max area (px²)</label>
                        <input type="number" id="orig-max-area" min="1" value="10000">
                    </div>
                    <div class="slider-row">
                        <label for="orig-circ">Min circularity</label>
                        <input type="range" id="orig-circ" min="0" max="100" value="0">
                        <span class="slider-val" id="orig-circ-val">0.00</span>
                    </div>
                    <hr class="section-divider">
                    <div class="check-row">
                        <label><input type="checkbox" id="show-labels"> Show cell numbers</label>
                    </div>
                </div>

                <!-- R panel -->
                <div class="ch-panel" data-ch="r" id="ch-panel-r">
                    <div class="ch-enabled-row"><label><input type="checkbox" id="ch-r-enabled" checked> Enable R
                            channel mask</label></div>
                    <div class="ch-body" id="ch-r-body">
                        <div class="slider-row"><label for="ch-r-thresh">Threshold</label><input type="range"
                                id="ch-r-thresh" min="0" max="255" value="128"><span class="slider-val"
                                id="ch-r-thresh-val">128</span></div>
                        <div class="check-row"><label><input type="checkbox" id="ch-r-otsu"> Otsu</label><label><input
                                    type="checkbox" id="ch-r-invert"> Invert</label></div>
                        <hr class="section-divider">
                        <div class="ch-enabled-row"><label><input type="checkbox" id="ch-r-override" checked> Override
                                area / circularity</label></div>
                        <div class="ch-body" id="ch-r-override-body">
                            <div class="area-row"><label for="ch-r-min-area">Min area (px²)</label><input type="number"
                                    id="ch-r-min-area" min="1" value="1"></div>
                            <div class="area-row"><label for="ch-r-max-area">Max area (px²)</label><input type="number"
                                    id="ch-r-max-area" min="1" value="10000"></div>
                            <div class="slider-row"><label for="ch-r-circ">Min circularity</label><input type="range"
                                    id="ch-r-circ" min="0" max="100" value="0"><span class="slider-val"
                                    id="ch-r-circ-val">0.00</span></div>
                        </div>
                    </div>
                </div>

                <!-- G panel -->
                <div class="ch-panel" data-ch="g" id="ch-panel-g">
                    <div class="ch-enabled-row"><label><input type="checkbox" id="ch-g-enabled" checked> Enable G
                            channel mask</label></div>
                    <div class="ch-body" id="ch-g-body">
                        <div class="slider-row"><label for="ch-g-thresh">Threshold</label><input type="range"
                                id="ch-g-thresh" min="0" max="255" value="128"><span class="slider-val"
                                id="ch-g-thresh-val">128</span></div>
                        <div class="check-row"><label><input type="checkbox" id="ch-g-otsu"> Otsu</label><label><input
                                    type="checkbox" id="ch-g-invert"> Invert</label></div>
                        <hr class="section-divider">
                        <div class="ch-enabled-row"><label><input type="checkbox" id="ch-g-override" checked> Override
                                area / circularity</label></div>
                        <div class="ch-body" id="ch-g-override-body">
                            <div class="area-row"><label for="ch-g-min-area">Min area (px²)</label><input type="number"
                                    id="ch-g-min-area" min="1" value="1"></div>
                            <div class="area-row"><label for="ch-g-max-area">Max area (px²)</label><input type="number"
                                    id="ch-g-max-area" min="1" value="10000"></div>
                            <div class="slider-row"><label for="ch-g-circ">Min circularity</label><input type="range"
                                    id="ch-g-circ" min="0" max="100" value="0"><span class="slider-val"
                                    id="ch-g-circ-val">0.00</span></div>
                        </div>
                    </div>
                </div>

                <!-- B panel -->
                <div class="ch-panel" data-ch="b" id="ch-panel-b">
                    <div class="ch-enabled-row"><label><input type="checkbox" id="ch-b-enabled" checked> Enable B
                            channel mask</label></div>
                    <div class="ch-body" id="ch-b-body">
                        <div class="slider-row"><label for="ch-b-thresh">Threshold</label><input type="range"
                                id="ch-b-thresh" min="0" max="255" value="128"><span class="slider-val"
                                id="ch-b-thresh-val">128</span></div>
                        <div class="check-row"><label><input type="checkbox" id="ch-b-otsu"> Otsu</label><label><input
                                    type="checkbox" id="ch-b-invert"> Invert</label></div>
                        <hr class="section-divider">
                        <div class="ch-enabled-row"><label><input type="checkbox" id="ch-b-override" checked> Override
                                area / circularity</label></div>
                        <div class="ch-body" id="ch-b-override-body">
                            <div class="area-row"><label for="ch-b-min-area">Min area (px²)</label><input type="number"
                                    id="ch-b-min-area" min="1" value="1"></div>
                            <div class="area-row"><label for="ch-b-max-area">Max area (px²)</label><input type="number"
                                    id="ch-b-max-area" min="1" value="10000"></div>
                            <div class="slider-row"><label for="ch-b-circ">Min circularity</label><input type="range"
                                    id="ch-b-circ" min="0" max="100" value="0"><span class="slider-val"
                                    id="ch-b-circ-val">0.00</span></div>
                        </div>
                    </div>
                </div>

            </div><!-- /ch-params-section -->
        </div>

        <!-- Conditional Count -->
        <div class="controls" id="cond-count-section">
            <h3>Conditional Count</h3>
            <div id="cond-rules"></div>
            <button id="cond-add-btn">＋ Add condition</button>
        </div>

        <!-- Result (grayscale) -->
        <div class="result-box">
            <div class="result-count" id="result-count">—</div>
            <div>
                <div class="result-label">cells detected <span style="font-size:11px;color:#94a3b8;">(grayscale)</span>
                </div>
                <div class="result-note" id="result-note"></div>
            </div>
        </div>
        <div class="result-save-row">
            <select id="result-fmt">
                <option value="png">PNG</option>
                <option value="jpeg">JPEG</option>
            </select>
            <button id="result-save-btn">⬇ Save Result</button>
        </div>

    </div>

    <div class="page-footer">Cell Counter &mdash; Lab Tools</div>

    <!-- UTIF.js for TIFF support -->
    <script src="https://cdn.jsdelivr.net/npm/utif@3.1.0/UTIF.js"></script>

    <!-- OpenCV.js (async, ~8 MB) — readiness detected via polling in cell_counter.js -->
    <script async id="opencv-script"
        src="https://cdn.jsdelivr.net/npm/@techstark/opencv-js@4.10.0-release.1/dist/opencv.js"
        onerror="onOpenCvError()"></script>

    <!-- Cell Counter logic (synchronous: ensures onOpenCvReady is global before onload fires) -->
    <script src="src/cell_counter.js"></script>
    <script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js"
        data-id="kemuchem" data-description="Support me on Buy me a coffee!" data-message="" data-color="#FF5F5F"
        data-position="Right" data-x_margin="18" data-y_margin="18"></script>
</body>

</html>